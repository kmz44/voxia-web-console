# VOXIA - Configuraci??n para Hosting Est??tico HostGator
# Optimizado para React SPA (Single Page Application)

# Habilitar mod_rewrite
RewriteEngine On

# Forzar HTTPS (Seguridad)
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ====================================
# CONTENT SECURITY POLICY PARA VOXIA
# ====================================
<IfModule mod_headers.c>
    # CSP para permitir YouTube, Gemini API, Supabase y recursos multimedia
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob: https://www.youtube.com https://s.ytimg.com https://www.google.com https://apis.google.com https://accounts.google.com; style-src 'self' 'unsafe-inline' https: https://fonts.googleapis.com; font-src 'self' data: https: https://fonts.gstatic.com; img-src 'self' data: https: blob: https://i.ytimg.com https://yt3.ggpht.com https://lh3.googleusercontent.com https://www.google.com; media-src 'self' data: blob: https: https://www.youtube.com; frame-src 'self' https: https://www.youtube.com https://youtube.com https://accounts.google.com https://www.google.com; connect-src 'self' https: wss: https://generativelanguage.googleapis.com https://www.googleapis.com https://accounts.google.com https://tcjhnibhoplfslqzprgl.supabase.co; worker-src 'self' blob:; child-src 'self' blob: https:; object-src 'none'; base-uri 'self'"
    
    # CORS headers para APIs externas
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    
    # Seguridad adicional pero compatible
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(self), camera=()"
</IfModule>

# Cache Control para archivos est??ticos
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Im??genes - 1 a??o
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS y JS - 1 mes
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fuentes - 1 a??o
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML - 1 d??a
    ExpiresByType text/html "access plus 1 day"
    
    # Manifest y otros archivos PWA - 1 semana
    ExpiresByType application/manifest+json "access plus 1 week"
</IfModule>

# Compresi??n Gzip
<IfModule mod_deflate.c>
    # Comprimir HTML, CSS, JavaScript, Text, XML y fuentes
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# Headers de seguridad
<IfModule mod_headers.c>
    # Permissions Policy para acceso a micr??fono
    Header always set Permissions-Policy "microphone=(self), camera=(self), geolocation=()"
    
    # Feature Policy (fallback para navegadores antiguos)
    Header always set Feature-Policy "microphone 'self'; camera 'self'; geolocation 'none'"
    
    # Pol??tica de seguridad de contenido (CSP) optimizada para VOXIA
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https: blob:; connect-src 'self' https: wss: ws:; font-src 'self' https:; media-src 'self' blob: data:; object-src 'none'; base-uri 'self'; form-action 'self'; worker-src 'self' blob:; manifest-src 'self';"
    
    # Prevenir clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevenir MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Habilitar protecci??n XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Cache control para archivos est??ticos
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # HTML sin cache
    <FilesMatch "\.html$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# Redirigir todas las rutas a index.html para React Router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]

# Bloquear acceso a archivos sensibles
<FilesMatch "\.(env|git|gitignore|log|md|txt|json)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Configurar tipos MIME
<IfModule mod_mime.c>
    AddType application/javascript .js
    AddType text/css .css
    AddType image/svg+xml .svg
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType application/manifest+json .webmanifest
</IfModule>

# Habilitar CORS para fuentes
<IfModule mod_headers.c>
    <FilesMatch "\.(woff|woff2|eot|ttf|otf)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# Optimizaci??n para PWA
<FilesMatch "manifest\.json$">
    Header set Content-Type "application/manifest+json"
</FilesMatch>

# Configuraci??n espec??fica para VOXIA
<FilesMatch "voxia-.*\.(png|jpg|jpeg|gif|svg)$">
    Header set Cache-Control "public, max-age=31536000"
</FilesMatch>


# ====================================
# CONFIGURACION ADICIONAL PARA PRODUCCION
# ====================================
# Configuraci??n adicional para VOXIA en producci??n
# Archivo para resolver problemas de CSP y CORS en hosting

# Permitir frame de YouTube espec??ficamente
<LocationMatch "/(youtube|embed)">
    Header always set X-Frame-Options "ALLOWALL"
</LocationMatch>

# Configuraci??n especial para manifest.json
<Files "manifest.json">
    Header set Content-Type "application/manifest+json"
    Header set Cache-Control "public, max-age=86400"
    Header always set Access-Control-Allow-Origin "*"
</Files>

# Configuraci??n para archivos de audio/video
<FilesMatch "\.(wav|mp3|mp4|webm|ogg|m4a)$">
    Header always set Access-Control-Allow-Origin "*"
    Header set Content-Security-Policy "media-src 'self' data: blob: https:"
</FilesMatch>

# Configuraci??n para Workers y Blobs
<FilesMatch "\.(js|mjs)$">
    Header always append Content-Security-Policy "worker-src 'self' blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https:"
</FilesMatch>

# Headers espec??ficos para YouTube API
SetEnvIf Origin "^https?://(www\.)?(youtube\.com|googleapis\.com|google\.com)$" CORS_ALLOWED_ORIGIN=$0
Header always set Access-Control-Allow-Origin "%{CORS_ALLOWED_ORIGIN}e" env=CORS_ALLOWED_ORIGIN

# Configuraci??n para archivos est??ticos con CSP relajado
<FilesMatch "\.(css|js|png|jpg|jpeg|gif|svg|woff|woff2)$">
    Header unset Content-Security-Policy
</FilesMatch>